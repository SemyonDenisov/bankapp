<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>

    <meta name="jwt-token" th:content="${jwtToken}"/>
    <meta name="client-credential-token" th:content="${clientCredentialToken}"/>

    <title>Корзина товаров</title>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        /* Стили для всплывашки */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
        }
    </style>


</head>

<body>

<script language="JavaScript">
    setInterval(() => {
        var td = document.getElementById('exchange_rates');
        fetch('http://localhost:8089/rates')
            .then(response => response.json())
            .then(json => {
                var table = '<table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">';
                table += '<tr><th colspan="2">Курсы валют по отношению к рублю</th></tr>';
                table += '<tr><th>Обозначение</th><th>Курс</th></tr>';
                json.forEach(rate => {
                    table += '<tr>';
                    table += '<td>' + rate.currency + '</td>';
                    table += '<td>' + rate.rate + '</td>';
                    table += '</tr>';
                });
                table += '</table>';
                td.innerHTML = table;
            })
            .catch(error => td.innerHTML = error);
    }, 1000);
</script>


<div id="toast"></div>

<script>

    async function fetchOldNotifications() {
        const token = document.querySelector('meta[name="jwt-token"]').getAttribute('content');
        console.log('Token:', token);

        try {
            const response = await fetch('http://localhost:8089/old-notifications');

            if (!response.ok) {
                throw new Error('Ошибка HTTP: ' + response.status);
            }

            const data = await response.json();
            console.log('Уведомления:', data);

            data.forEach((message, index) => {
                setTimeout(() => {
                    showToast(message);
                }, index * 3500); // показываем по очереди
            });

        } catch (error) {
            console.error('Ошибка при получении уведомлений:', error);
        }
    }

    fetchOldNotifications();

    // Подключение к WebSocket
    const socket = new SockJS('http://localhost:8083/ws');
    const stompClient = Stomp.over(socket);

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    stompClient.connect({}, function (frame) {
        console.log('WebSocket подключён:', frame);

        stompClient.subscribe('/topic/alerts', function (notification) {
            showToast(notification.body);
        });
    }, function (error) {
        console.error('Ошибка подключения WebSocket:', error);
    });
</script>


<a href="/signup" style="float:right;">
    <b>РЕГИСТРАЦИЯ</b>
</a>
<a href="/logout" style="float:right;">
    <b>ВЫЙТИ</b>
</a>
<table style="width:70%;margin-left:auto;margin-right:auto;">
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/user/editPassword'}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr>
                        <td style="font-weight:bold;">Логин</td>
                        <td colspan="2" th:text="${login}"></td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Изменить пароль</td>
                        <td>
                            <p style="color:red;" th:if="${passwordErrors!=null}"
                               th:each="passwordError : ${passwordErrors}" th:text="${passwordError}"></p>
                            <p>
                                Пароль: <input name="password" type="password" required="required"/>
                            </p>
                            <p>
                                Повторите пароль: <input name="confirm_password" type="password" required="required"/>
                            </p>
                        </td>
                        <td style="text-align:right">
                            <button>Изменить пароль</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/user/editUserAccounts'}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr th:if="${userAccountsErrors!=null}" th:each="userAccountsError : ${userAccountsErrors}">
                        <td style="color:red;" th:text="${userAccountsError}"></td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Фамилия Имя</td>
                        <td th:text="${name}"></td>
                        <td>
                            <input name="name" type="text" style="width:100%"/>
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Дата рождения</td>
                        <td th:text="${birthdate}"></td>
                        <td>
                            <input name="birthdate" type="date" style="width:100%"/>
                        </td>
                    </tr>
                    <tr th:each="account : ${accounts}">
                        <td style="font-weight:bold;" th:text="${account.getCurrency()}"></td>
                        <td th:text="${account.isExists() ? (account.getBalance()+' '+account.getCurrency()) : ''}"></td>
                        <td style="text-align:right">
                            <input name="account" type="checkbox" th:checked="${account.isExists()}"
                                   th:value="${account.getCurrency()}"/>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right" colspan="3">
                            <button>Сохранить изменения</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/user/cash'}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr th:if="${cashErrors!=null}" th:each="cashError : ${cashErrors}">
                        <td style="color:red;" th:text="${cashError}"></td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Наличные</td>
                        <td>
                            Валюта
                            <select name="currency">
                                <option th:each="eachCurrency : ${currency}" th:text="${eachCurrency}"/>
                            </select>
                        </td>
                        <td>
                            <input name="value" type="number" style="width:100%" required="required"/>
                        </td>
                        <td style="text-align:right">
                            <button name="action" value="PUT">Положить</button>
                            <button name="action" value="GET">Снять</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/user/transfer'}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr th:if="${transferErrors!=null}" th:each="transferError : ${transferErrors}">
                        <td style="color:red;" th:text="${transferError}"></td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Перевод себе</td>
                        <td>
                            Со счета
                            <select name="from_currency">
                                <option th:each="eachCurrency : ${currency}" th:text="${eachCurrency}"></option>
                            </select>
                        </td>
                        <td>
                            На счет
                            <select name="to_currency">
                                <option th:each="eachCurrency : ${currency}" th:text="${eachCurrency}"></option>
                            </select>
                        </td>
                        <td>
                            <input name="value" type="number" style="width:100%" required="required"/>
                        </td>
                        <td style="text-align:right">
                            <input type="hidden" name="to_login" th:value="${login}"/>
                            <button>Перевести</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/user/transfer'}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr th:if="${transferOtherErrors!=null}" th:each="transferOtherError : ${transferOtherErrors}">
                        <td style="color:red;" th:text="${transferOtherError}"></td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Перевод другому</td>
                        <td>
                            Со счета
                            <select name="from_currency">
                                <option th:each="eachCurrency : ${currency}" th:text="${eachCurrency}"></option>
                            </select>
                        </td>
                        <td>
                            На счет
                            <select name="to_currency">
                                <option th:each="eachCurrency : ${currencyToSend}" th:text="${eachCurrency}"></option>
                            </select>
                        </td>
                        <td>
                            <input name="value" type="number" required="required"/>
                        </td>
                        <td>
                            Кому
                            <select name="to_login">
                                <option th:each="user : ${users}" th:value="${user.getLogin()}"
                                        th:text="${user.getUsername()}"></option>
                            </select>
                        </td>
                        <td style="text-align:right">
                            <button>Перевести</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;" id="exchange_rates">
        </td>
    </tr>
</table>
</body>

</html>
